<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>International Poll - Trump Presidency 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            position: relative;
        }
        
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .lang-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .lang-btn.active {
            background: #667eea;
            color: white;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            padding-right: 250px;
            margin-top: 10px;
        }
        
        .question {
            color: #333;
            font-size: 22px;
            margin: 20px 0;
            font-weight: 700;
        }
        
        .subtitle {
            color: #333;
            font-size: 14px;
            font-style: italic;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 700;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .radio-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .radio-option label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .survey-period {
            text-align: center;
            color: #888;
            font-size: 14px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .results-section {
            display: none;
        }
        
        .results-section.show {
            display: block;
        }
        
        .results-header {
            margin-bottom: 10px;
        }
        
        .results-subtitle {
            color: #667eea;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .total-votes {
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 30px;
        }
        
        .result-bar {
            margin-bottom: 20px;
        }
        
        .result-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .bar-container {
            width: 100%;
            height: 40px;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
        }
        
        .bar-fill.low {
            justify-content: flex-start;
            padding-left: 10px;
        }
        
        .percentage-outside {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 600;
            color: #555;
        }
        
        .country-filter {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .country-filter label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .country-filter select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
        
        .message {
            background: #f0f0f0;
            border: 2px solid #667eea;
            color: #333;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
        }
        
        .success {
            background: #efe;
            border: 2px solid #3c3;
            color: #060;
        }
        
        .warning {
            background: #ffe;
            border: 2px solid #fc3;
            color: #660;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 22px;
                padding-right: 0;
                margin-top: 60px;
            }
            
            .language-switcher {
                top: 10px;
                right: 10px;
                left: 10px;
                justify-content: center;
            }
            
            .question {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Language Switcher -->
        <div class="language-switcher">
            <button class="lang-btn active" onclick="switchLanguage('en', event)">English</button>
            <button class="lang-btn" onclick="switchLanguage('fr', event)">Français</button>
            <button class="lang-btn" onclick="switchLanguage('es', event)">Español</button>
        </div>
        
        <!-- Poll Form -->
        <div id="pollForm" class="poll-section">
            <h1 id="title">ANONYMOUS INTERNATIONAL POLL</h1>
            <p class="question" id="question">How do you evaluate Trump's presidency in 2026?</p>
            <p class="subtitle" id="subtitle">(An independent grassroots initiative to give a voice to citizens of democratic countries outside the USA)</p>
            
            <form id="voteForm">
                <div class="form-group">
                    <label id="ratingLabel">Your evaluation:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="strongly_approve" name="rating" value="strongly_approve" required>
                            <label for="strongly_approve" id="label_strongly_approve">Strongly approve</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="approve" name="rating" value="approve" required>
                            <label for="approve" id="label_approve">Approve</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="neutral" name="rating" value="neutral" required>
                            <label for="neutral" id="label_neutral">Neutral</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="disapprove" name="rating" value="disapprove" required>
                            <label for="disapprove" id="label_disapprove">Disapprove</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="strongly_disapprove" name="rating" value="strongly_disapprove" required>
                            <label for="strongly_disapprove" id="label_strongly_disapprove">Strongly disapprove</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">Submit Vote</button>
            </form>
            
            <p class="survey-period" id="surveyPeriod">Survey period: February 10 - May 10, 2026</p>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <div class="results-header">
                <h1 id="resultsTitle">ANONYMOUS INTERNATIONAL POLL</h1>
                <p class="question" id="resultsQuestion">How do you evaluate Trump's presidency in 2026?</p>
                <p class="results-subtitle" id="resultsSubtitle">Poll Results</p>
            </div>
            
            <div class="total-votes" id="totalVotes">Total votes: 0</div>
            
            <div class="country-filter">
                <label for="countryFilter" id="filterLabel">Filter by country (optional):</label>
                <select id="countryFilter">
                    <option value="">All Countries</option>
                </select>
            </div>
            
            <div id="resultsChart"></div>
            
            <p class="survey-period" id="surveyPeriodResults">Survey period: February 10 - May 10, 2026</p>
        </div>
        
        <!-- Message Display -->
        <div id="messageDisplay" style="display: none;">
            <div class="message" id="messageText"></div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, increment, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAwG5in8oGwiwwRYD0m3_tCl1U2fmT4FwQ",
            authDomain: "trump-poll-2026.firebaseapp.com",
            projectId: "trump-poll-2026",
            storageBucket: "trump-poll-2026.firebasestorage.app",
            messagingSenderId: "807374750743",
            appId: "1:807374750743:web:9078a37dc55c23e545c852"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Language translations
        const translations = {
            en: {
                title: "ANONYMOUS INTERNATIONAL POLL",
                question: "How do you evaluate Trump's presidency in 2026?",
                subtitle: "(An independent grassroots initiative to give a voice to citizens of democratic countries outside the USA)",
                ratingLabel: "Your evaluation:",
                strongly_approve: "Strongly approve",
                approve: "Approve",
                neutral: "Neutral",
                disapprove: "Disapprove",
                strongly_disapprove: "Strongly disapprove",
                submitBtn: "Submit Vote",
                surveyPeriod: "Survey period: February 10 - May 10, 2026",
                thankYou: "Thank you for your vote!",
                alreadyVoted: "You have already voted",
                blocked: "USA citizens and citizens from non-democratic nations cannot participate",
                resultsTitle: "ANONYMOUS INTERNATIONAL POLL",
                resultsSubtitle: "Poll Results",
                totalVotes: "Total votes:",
                filterLabel: "Filter by country (optional):",
                allCountries: "All Countries",
                // Country name translations
                countries: {
                    "Argentina": "Argentina", "Australia": "Australia", "Austria": "Austria", 
                    "Belgium": "Belgium", "Botswana": "Botswana", "Brazil": "Brazil", 
                    "Bulgaria": "Bulgaria", "Canada": "Canada", "Cape Verde": "Cape Verde", 
                    "Chile": "Chile", "Colombia": "Colombia", "Costa Rica": "Costa Rica", 
                    "Croatia": "Croatia", "Cyprus": "Cyprus", "Czech Republic": "Czech Republic", 
                    "Denmark": "Denmark", "Dominican Republic": "Dominican Republic", 
                    "Estonia": "Estonia", "Finland": "Finland", "France": "France", 
                    "Germany": "Germany", "Ghana": "Ghana", "Greece": "Greece", 
                    "Hungary": "Hungary", "Iceland": "Iceland", "India": "India", 
                    "Indonesia": "Indonesia", "Ireland": "Ireland", "Israel": "Israel", 
                    "Italy": "Italy", "Jamaica": "Jamaica", "Japan": "Japan", 
                    "Latvia": "Latvia", "Lithuania": "Lithuania", "Luxembourg": "Luxembourg", 
                    "Malaysia": "Malaysia", "Malta": "Malta", "Mauritius": "Mauritius", 
                    "Mexico": "Mexico", "Mongolia": "Mongolia", "Namibia": "Namibia", 
                    "Netherlands": "Netherlands", "New Zealand": "New Zealand", 
                    "Norway": "Norway", "Panama": "Panama", "Papua New Guinea": "Papua New Guinea", 
                    "Paraguay": "Paraguay", "Peru": "Peru", "Philippines": "Philippines", 
                    "Poland": "Poland", "Portugal": "Portugal", "Romania": "Romania", 
                    "Senegal": "Senegal", "Serbia": "Serbia", "Slovakia": "Slovakia", 
                    "Slovenia": "Slovenia", "South Africa": "South Africa", 
                    "South Korea": "South Korea", "Spain": "Spain", "Sri Lanka": "Sri Lanka", 
                    "Suriname": "Suriname", "Sweden": "Sweden", "Switzerland": "Switzerland", 
                    "Taiwan": "Taiwan", "Thailand": "Thailand", "Timor-Leste": "Timor-Leste", 
                    "Trinidad and Tobago": "Trinidad and Tobago", "Tunisia": "Tunisia", 
                    "Ukraine": "Ukraine", "United Kingdom": "United Kingdom", 
                    "Uruguay": "Uruguay", "Zambia": "Zambia"
                }
            },
            fr: {
                title: "SONDAGE INTERNATIONAL ANONYME",
                question: "Comment évaluez-vous la présidence de Trump en 2026?",
                subtitle: "(Une initiative populaire indépendante pour donner la parole aux citoyens des pays démocratiques hors États-Unis)",
                ratingLabel: "Votre évaluation:",
                strongly_approve: "J'approuve totalement",
                approve: "J'approuve",
                neutral: "Neutre",
                disapprove: "Je désapprouve",
                strongly_disapprove: "Je désapprouve totalement",
                submitBtn: "Soumettre le vote",
                surveyPeriod: "Période d'enquête: 10 Février - 10 Mai, 2026",
                thankYou: "Merci pour votre vote!",
                alreadyVoted: "Vous avez déjà voté",
                blocked: "Les citoyens américains et les citoyens de nations non démocratiques ne peuvent pas participer",
                resultsTitle: "SONDAGE INTERNATIONAL ANONYME",
                resultsSubtitle: "Résultats du sondage",
                totalVotes: "Total des votes:",
                filterLabel: "Filtrer par pays (optionnel):",
                allCountries: "Tous les pays",
                countries: {
                    "Argentina": "Argentine", "Australia": "Australie", "Austria": "Autriche",
                    "Belgium": "Belgique", "Botswana": "Botswana", "Brazil": "Brésil",
                    "Bulgaria": "Bulgarie", "Canada": "Canada", "Cape Verde": "Cap-Vert",
                    "Chile": "Chili", "Colombia": "Colombie", "Costa Rica": "Costa Rica",
                    "Croatia": "Croatie", "Cyprus": "Chypre", "Czech Republic": "République tchèque",
                    "Denmark": "Danemark", "Dominican Republic": "République dominicaine",
                    "Estonia": "Estonie", "Finland": "Finlande", "France": "France",
                    "Germany": "Allemagne", "Ghana": "Ghana", "Greece": "Grèce",
                    "Hungary": "Hongrie", "Iceland": "Islande", "India": "Inde",
                    "Indonesia": "Indonésie", "Ireland": "Irlande", "Israel": "Israël",
                    "Italy": "Italie", "Jamaica": "Jamaïque", "Japan": "Japon",
                    "Latvia": "Lettonie", "Lithuania": "Lituanie", "Luxembourg": "Luxembourg",
                    "Malaysia": "Malaisie", "Malta": "Malte", "Mauritius": "Maurice",
                    "Mexico": "Mexique", "Mongolia": "Mongolie", "Namibia": "Namibie",
                    "Netherlands": "Pays-Bas", "New Zealand": "Nouvelle-Zélande",
                    "Norway": "Norvège", "Panama": "Panama", "Papua New Guinea": "Papouasie-Nouvelle-Guinée",
                    "Paraguay": "Paraguay", "Peru": "Pérou", "Philippines": "Philippines",
                    "Poland": "Pologne", "Portugal": "Portugal", "Romania": "Roumanie",
                    "Senegal": "Sénégal", "Serbia": "Serbie", "Slovakia": "Slovaquie",
                    "Slovenia": "Slovénie", "South Africa": "Afrique du Sud",
                    "South Korea": "Corée du Sud", "Spain": "Espagne", "Sri Lanka": "Sri Lanka",
                    "Suriname": "Suriname", "Sweden": "Suède", "Switzerland": "Suisse",
                    "Taiwan": "Taïwan", "Thailand": "Thaïlande", "Timor-Leste": "Timor-Leste",
                    "Trinidad and Tobago": "Trinité-et-Tobago", "Tunisia": "Tunisie",
                    "Ukraine": "Ukraine", "United Kingdom": "Royaume-Uni",
                    "Uruguay": "Uruguay", "Zambia": "Zambie"
                }
            },
            es: {
                title: "ENCUESTA INTERNACIONAL ANÓNIMA",
                question: "¿Cómo evalúa la presidencia de Trump en 2026?",
                subtitle: "(Una iniciativa popular independiente para dar voz a ciudadanos de países democráticos fuera de Estados Unidos)",
                ratingLabel: "Su evaluación:",
                strongly_approve: "Apruebo totalmente",
                approve: "Apruebo",
                neutral: "Neutral",
                disapprove: "Desapruebo",
                strongly_disapprove: "Desapruebo totalmente",
                submitBtn: "Enviar voto",
                surveyPeriod: "Período de encuesta: 10 Febrero – 10 Mayo, 2026",
                thankYou: "¡Gracias por su voto!",
                alreadyVoted: "Ya ha votado",
                blocked: "Los ciudadanos estadounidenses y ciudadanos de naciones no democráticas no pueden participar",
                resultsTitle: "ENCUESTA INTERNACIONAL ANÓNIMA",
                resultsSubtitle: "Resultados de la encuesta",
                totalVotes: "Total de votos:",
                filterLabel: "Filtrar por país (opcional):",
                allCountries: "Todos los países",
                countries: {
                    "Argentina": "Argentina", "Australia": "Australia", "Austria": "Austria",
                    "Belgium": "Bélgica", "Botswana": "Botsuana", "Brazil": "Brasil",
                    "Bulgaria": "Bulgaria", "Canada": "Canadá", "Cape Verde": "Cabo Verde",
                    "Chile": "Chile", "Colombia": "Colombia", "Costa Rica": "Costa Rica",
                    "Croatia": "Croacia", "Cyprus": "Chipre", "Czech Republic": "República Checa",
                    "Denmark": "Dinamarca", "Dominican Republic": "República Dominicana",
                    "Estonia": "Estonia", "Finland": "Finlandia", "France": "Francia",
                    "Germany": "Alemania", "Ghana": "Ghana", "Greece": "Grecia",
                    "Hungary": "Hungría", "Iceland": "Islandia", "India": "India",
                    "Indonesia": "Indonesia", "Ireland": "Irlanda", "Israel": "Israel",
                    "Italy": "Italia", "Jamaica": "Jamaica", "Japan": "Japón",
                    "Latvia": "Letonia", "Lithuania": "Lituania", "Luxembourg": "Luxemburgo",
                    "Malaysia": "Malasia", "Malta": "Malta", "Mauritius": "Mauricio",
                    "Mexico": "México", "Mongolia": "Mongolia", "Namibia": "Namibia",
                    "Netherlands": "Países Bajos", "New Zealand": "Nueva Zelanda",
                    "Norway": "Noruega", "Panama": "Panamá", "Papua New Guinea": "Papúa Nueva Guinea",
                    "Paraguay": "Paraguay", "Peru": "Perú", "Philippines": "Filipinas",
                    "Poland": "Polonia", "Portugal": "Portugal", "Romania": "Rumania",
                    "Senegal": "Senegal", "Serbia": "Serbia", "Slovakia": "Eslovaquia",
                    "Slovenia": "Eslovenia", "South Africa": "Sudáfrica",
                    "South Korea": "Corea del Sur", "Spain": "España", "Sri Lanka": "Sri Lanka",
                    "Suriname": "Surinam", "Sweden": "Suecia", "Switzerland": "Suiza",
                    "Taiwan": "Taiwán", "Thailand": "Tailandia", "Timor-Leste": "Timor-Leste",
                    "Trinidad and Tobago": "Trinidad y Tobago", "Tunisia": "Túnez",
                    "Ukraine": "Ucrania", "United Kingdom": "Reino Unido",
                    "Uruguay": "Uruguay", "Zambia": "Zambia"
                }
            }
        };

        // List of allowed democratic countries (English names - used as keys)
        const allowedCountries = [
            "Argentina", "Australia", "Austria", "Belgium", "Botswana", "Brazil", "Bulgaria",
            "Canada", "Cape Verde", "Chile", "Colombia", "Costa Rica", "Croatia", "Cyprus",
            "Czech Republic", "Denmark", "Dominican Republic", "Estonia", "Finland", "France",
            "Germany", "Ghana", "Greece", "Hungary", "Iceland", "India", "Indonesia", "Ireland",
            "Israel", "Italy", "Jamaica", "Japan", "Latvia", "Lithuania", "Luxembourg", "Malaysia",
            "Malta", "Mauritius", "Mexico", "Mongolia", "Namibia", "Netherlands", "New Zealand",
            "Norway", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland",
            "Portugal", "Romania", "Senegal", "Serbia", "Slovakia", "Slovenia", "South Africa",
            "South Korea", "Spain", "Sri Lanka", "Suriname", "Sweden", "Switzerland", "Taiwan",
            "Thailand", "Timor-Leste", "Trinidad and Tobago", "Tunisia", "Ukraine", "United Kingdom",
            "Uruguay", "Zambia"
        ];

        let currentLang = 'en';
        let userCountry = null;

        // Populate country filter dropdown with translated names
        function populateCountryFilter() {
            const countryFilter = document.getElementById('countryFilter');
            const currentFilterValue = countryFilter.value;
            const t = translations[currentLang];
            
            countryFilter.innerHTML = `<option value="">${t.allCountries}</option>`;
            
            // Sort countries by translated name
            const sortedCountries = [...allowedCountries].sort((a, b) => {
                const nameA = t.countries[a] || a;
                const nameB = t.countries[b] || b;
                return nameA.localeCompare(nameB);
            });
            
            sortedCountries.forEach(countryKey => {
                const option = document.createElement('option');
                option.value = countryKey;
                option.textContent = t.countries[countryKey] || countryKey;
                countryFilter.appendChild(option);
            });
            
            if (currentFilterValue) {
                countryFilter.value = currentFilterValue;
            }
        }

        // Switch language
        window.switchLanguage = function(lang, event) {
            currentLang = lang;
            
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                const buttons = document.querySelectorAll('.lang-btn');
                buttons.forEach(btn => {
                    if (btn.textContent === 'English' && lang === 'en') btn.classList.add('active');
                    if (btn.textContent === 'Français' && lang === 'fr') btn.classList.add('active');
                    if (btn.textContent === 'Español' && lang === 'es') btn.classList.add('active');
                });
            }
            
            // Update all text
            const t = translations[lang];
            document.getElementById('title').textContent = t.title;
            document.getElementById('question').textContent = t.question;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('ratingLabel').textContent = t.ratingLabel;
            document.getElementById('label_strongly_approve').textContent = t.strongly_approve;
            document.getElementById('label_approve').textContent = t.approve;
            document.getElementById('label_neutral').textContent = t.neutral;
            document.getElementById('label_disapprove').textContent = t.disapprove;
            document.getElementById('label_strongly_disapprove').textContent = t.strongly_disapprove;
            document.getElementById('submitBtn').textContent = t.submitBtn;
            document.getElementById('surveyPeriod').textContent = t.surveyPeriod;
            document.getElementById('resultsTitle').textContent = t.resultsTitle;
            document.getElementById('resultsQuestion').textContent = t.question;
            document.getElementById('resultsSubtitle').textContent = t.resultsSubtitle;
            document.getElementById('filterLabel').textContent = t.filterLabel;
            document.getElementById('surveyPeriodResults').textContent = t.surveyPeriod;
            
            populateCountryFilter();
            
            // If results are showing, refresh them with new language
            if (document.getElementById('resultsSection').classList.contains('show')) {
                const filterCountry = document.getElementById('countryFilter').value;
                loadResults(filterCountry);
            }
        };

        // Get user's IP and country
        async function getUserLocation() {
            try {
                // First get IP
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const ip = ipData.ip;
                
                // Then get country from IP
                const geoResponse = await fetch(`https://ipapi.co/${ip}/json/`);
                const geoData = await geoResponse.json();
                
                return {
                    ip: ip,
                    country: geoData.country_name || 'Unknown'
                };
            } catch (error) {
                console.error('Error getting location:', error);
                return { ip: null, country: 'Unknown' };
            }
        }

        // Check if user has already voted
        async function hasVoted(ip) {
            if (!ip) return false;
            
            try {
                const votesRef = collection(db, 'votes');
                const q = query(votesRef, where('ip', '==', ip));
                const querySnapshot = await getDocs(q);
                return !querySnapshot.empty;
            } catch (error) {
                console.error('Error checking vote:', error);
                // If there's an error checking, block voting to be safe
                return true;
            }
        }

        // Check if country is allowed to vote
        function isCountryAllowed(country) {
            // Block USA
            if (country === 'United States' || country === 'USA') {
                return false;
            }
            
            // Check if country is in allowed list
            return allowedCountries.includes(country);
        }

        // Show message and redirect to results
        function showMessageAndRedirect(messageKey, duration, isSuccess = false) {
            const t = translations[currentLang];
            
            document.getElementById('pollForm').style.display = 'none';
            document.getElementById('resultsSection').classList.remove('show');
            document.getElementById('messageDisplay').style.display = 'block';
            
            const messageDiv = document.getElementById('messageText');
            messageDiv.textContent = t[messageKey];
            messageDiv.className = isSuccess ? 'message success' : 'message warning';
            
            setTimeout(() => {
                document.getElementById('messageDisplay').style.display = 'none';
                document.getElementById('resultsSection').classList.add('show');
                
                // Reset country filter to show all countries
                document.getElementById('countryFilter').value = '';
                
                loadResults();
            }, duration);
        }

        // Submit vote
        async function submitVote(country, rating, ip) {
            try {
                // Add vote to database
                await addDoc(collection(db, 'votes'), {
                    country: country,
                    rating: rating,
                    ip: ip,
                    timestamp: serverTimestamp()
                });

                // Update country-specific results
                const countryDocId = `${country}_${rating}`;
                const countryRef = doc(db, 'results', countryDocId);
                
                const countryDoc = await getDoc(countryRef);
                if (countryDoc.exists()) {
                    await updateDoc(countryRef, {
                        count: increment(1)
                    });
                } else {
                    await setDoc(countryRef, {
                        country: country,
                        rating: rating,
                        count: 1
                    });
                }

                // Update overall results
                const overallDocId = `overall_${rating}`;
                const overallRef = doc(db, 'results', overallDocId);
                
                const overallDoc = await getDoc(overallRef);
                if (overallDoc.exists()) {
                    await updateDoc(overallRef, {
                        count: increment(1)
                    });
                } else {
                    await setDoc(overallRef, {
                        country: 'overall',
                        rating: rating,
                        count: 1
                    });
                }

                return true;
            } catch (error) {
                console.error('Error submitting vote:', error);
                return false;
            }
        }

        // Load and display results
        async function loadResults(filterCountry = '') {
            try {
                const resultsRef = collection(db, 'results');
                let q;
                
                if (filterCountry) {
                    q = query(resultsRef, where('country', '==', filterCountry));
                } else {
                    q = query(resultsRef, where('country', '==', 'overall'));
                }
                
                const querySnapshot = await getDocs(q);
                
                const results = {
                    strongly_approve: 0,
                    approve: 0,
                    neutral: 0,
                    disapprove: 0,
                    strongly_disapprove: 0
                };
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.rating && results.hasOwnProperty(data.rating)) {
                        results[data.rating] = data.count || 0;
                    }
                });
                
                displayResults(results);
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        // Display results with bars
        function displayResults(results) {
            const total = Object.values(results).reduce((a, b) => a + b, 0);
            const t = translations[currentLang];
            
            document.getElementById('totalVotes').textContent = `${t.totalVotes} ${total}`;
            
            const chartDiv = document.getElementById('resultsChart');
            chartDiv.innerHTML = '';
            
            const ratings = [
                { key: 'strongly_approve', color: '#10b981' },
                { key: 'approve', color: '#3b82f6' },
                { key: 'neutral', color: '#8b5cf6' },
                { key: 'disapprove', color: '#f59e0b' },
                { key: 'strongly_disapprove', color: '#ef4444' }
            ];
            
            ratings.forEach(rating => {
                const count = results[rating.key] || 0;
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                
                const barDiv = document.createElement('div');
                barDiv.className = 'result-bar';
                barDiv.innerHTML = `
                    <div class="result-label">
                        <span>${t[rating.key]}</span>
                        <span>${count} ${count === 1 ? 'vote' : 'votes'}</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill ${percentage < 10 ? 'low' : ''}" style="width: ${percentage}%; background: ${rating.color}">
                            ${percentage >= 10 ? percentage + '%' : ''}
                        </div>
                        ${percentage < 10 ? `<span class="percentage-outside">${percentage}%</span>` : ''}
                    </div>
                `;
                chartDiv.appendChild(barDiv);
            });
        }

        // Handle form submission
        document.getElementById('voteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const rating = document.querySelector('input[name="rating"]:checked').value;
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            const success = await submitVote(userCountry, rating, window.userIP);
            
            if (success) {
                showMessageAndRedirect('thankYou', 3000, true);
            } else {
                alert('Error submitting vote. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = translations[currentLang].submitBtn;
            }
        });

        // Handle country filter
        document.getElementById('countryFilter').addEventListener('change', (e) => {
            loadResults(e.target.value);
        });

        // Initialize on page load
        window.addEventListener('load', async () => {
            switchLanguage('en');
            
            const location = await getUserLocation();
            window.userIP = location.ip;
            userCountry = location.country;
            
            console.log('User location:', location);
            
            if (!location.ip) {
                alert('Could not verify your connection. Please check your internet and try again.');
                return;
            }
            
            // Check if already voted
            const alreadyVoted = await hasVoted(location.ip);
            if (alreadyVoted) {
                showMessageAndRedirect('alreadyVoted', 2000);
                return;
            }
            
            // Check if country is allowed
            if (!isCountryAllowed(userCountry)) {
                showMessageAndRedirect('blocked', 5000);
                return;
            }
            
            // If we get here, user can vote
            document.getElementById('pollForm').style.display = 'block';
        });
    </script>
</body>
</html>
